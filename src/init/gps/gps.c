/*
 * g_gps.c
 *
 *  Created on: Jun 21, 2025
 *      Author: mia00
 */


#include "gps.h"
#include "pp.h"
#include "vmd.h"
#include <stdio.h>

#include "crsf/crsf.h"

struct ubx_gps g_gps;

struct ubx_nav_pvt g_gps_nav_pvt;


//uart1
const uint8_t UBX_CFG_PRT[28] = {
		0xB5, 0x62, 0x06, 0x00, 0x14, 0x00, 0x01, 0x00,
		0x00, 0x00, 0xD0, 0x08, 0x00, 0x00, 0x00, 0x96,
		0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x8B, 0x54
};

//NAV PVT
const uint8_t UBX_CFG_MSG[16] = {
		0xB5, 0x62, 0x06, 0x01, 0x08, 0x00, 0x01, 0x07,
		0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x18, 0xE1
};

//5hz
const uint8_t UBX_CFG_RATE[14] = {
		0xB5, 0x62, 0x06, 0x08, 0x06, 0x00, 0xC8, 0x00,
		0x01, 0x00, 0x00, 0x00, 0xDD, 0x68
};

//TODO : default setting 추가.
//save current
const uint8_t UBX_CFG_CFG[21] = {
		0xB5, 0x62, 0x06, 0x09, 0x0D, 0x00, 0x00, 0x00,
		0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x17, 0x31, 0xBF
};

bool gps_init()
{
	bool tmp;
	tmp = ubx_gps_init(&g_gps, &huart6);
	if (!tmp) {
		return false;
	}

	tmp = ubx_send_data(&g_gps, UBX_CFG_PRT, 28);
	if (!tmp) {
		return false;
	}

	tmp = ubx_send_data(&g_gps, UBX_CFG_MSG, 16);
	if (!tmp) {
		return false;
	}

	tmp = ubx_send_data(&g_gps, UBX_CFG_RATE, 14);
	if (!tmp) {
		return false;
	}

	tmp = ubx_send_data(&g_gps, UBX_CFG_CFG, 21);
	if (!tmp) {
		return false;
	}

	tmp = ubx_gps_begin(&g_gps);
	if (!tmp) {
		return false;
	}

	return true;
}



